# guandan-score 项目编程规则

═══════════════════════════════════════════════════════════════════════════════

## 📋 总体原则

**代码质量优先**：可读性、可维护性、可扩展性
**安全第一**：数据安全、用户隐私、系统稳定
**性能考虑**：响应速度、资源占用、用户体验
**需求驱动**：所有功能开发必须基于项目概述和需求文档框架

## 📋 需求驱动开发规则

### 核心要求
**分析代码和提出优化建议或者新增、优化、调整小程序功能时，必须在项目概述和需求文档的框架下实施。**

### 具体执行标准
- **功能开发前**: 必须先查阅 `项目概述和需求.md` 文档
- **需求对齐**: 确保新功能符合功能需求中的模块划分
- **架构遵循**: 新功能必须遵循系统架构中的模块职责分工
- **性能要求**: 优化必须满足非功能需求中的性能指标
- **数据规范**: 数据操作必须符合数据需求中的结构定义
- **界面标准**: UI改动必须遵循用户界面需求中的设计原则

### 检查清单
- [ ] 是否已查阅项目概述和需求文档？
- [ ] 新功能是否属于已定义的功能模块？
- [ ] 是否符合系统架构的模块职责？
- [ ] 是否满足非功能需求的性能要求？
- [ ] 数据操作是否符合数据结构定义？
- [ ] UI改动是否符合界面设计原则？

## 🔄 开发流程

### 任务分析阶段
- 仔细阅读用户需求，理解要做什么
- **查阅官方文档**：涉及API、技术方案时必须先查阅官方最新文档
- **必须参考项目概述和需求文档**，确保功能符合需求框架
- 分析现有代码结构，确定修改范围
- 制定详细的实现方案
- **用户确认**：方案制定后先与用户确认，不要急于修改代码

### 代码修改阶段
- 按照方案逐步修改代码
- 每次修改后立即测试
- 确保修改不会影响现有功能，除非要求调整优化功能或者添加新功能。

### 测试验证阶段
- 全面测试修改后的功能
- 检查是否有语法错误或逻辑错误
- 确保所有功能正常工作

### 文档更新阶段
- 更新相关文档
- 记录修改内容和注意事项
- 提供使用说明

### 代码审查阶段
- 检查代码质量和规范性
- 确保代码可读性和可维护性
- 优化性能（如需要）

═══════════════════════════════════════════════════════════════════════════════

## 🎯 代码规范

### 命名规范
- **变量名**：使用驼峰命名法，语义清晰
  ```javascript
  // ✅ 正确
  const gameScore = 100;
  const playerName = "玩家1";
  
  // ❌ 错误
  const a = 100;
  const p1 = "玩家1";
  ```

- **函数名**：动词开头，功能明确
  ```javascript
  // ✅ 正确
  function calculateScore() {}
  function updateGameState() {}
  
  // ❌ 错误
  function calc() {}
  function update() {}
  ```

- **文件名**：小写字母，用连字符分隔
  ```
  // ✅ 正确
  game-rules.js
  score-logic.js
  
  // ❌ 错误
  GameRules.js
  scoreLogic.js
  ```

### 注释规范
- **文件头部**：说明文件用途和主要功能
  ```javascript
  /**
   * 游戏规则管理模块
   * 负责处理掼蛋游戏的规则逻辑
   * @author Jennifer
   * @date 2024-09-20
   */
  ```

- **函数注释**：说明参数、返回值和功能
  ```javascript
  /**
   * 计算游戏得分
   * @param {Object} gameData - 游戏数据对象
   * @param {number} gameData.level - 游戏等级
   * @param {boolean} gameData.isWin - 是否胜利
   * @returns {number} 计算后的得分
   */
  function calculateScore(gameData) {
    // 实现逻辑
  }
  ```

### 代码结构
- **模块化**：单一职责，高内聚低耦合
- **分层架构**：UI层、业务层、数据层分离
- **错误处理**：完善的异常捕获和用户提示

### 时间处理规范
- **动态时间**：必须使用系统时间API
  ```javascript
  // ✅ 正确：当前时间用系统API
  const createdAt = new Date()
  const timestamp = Date.now()
  const serverTime = db.serverDate() // 云数据库
  
  // ❌ 错误：动态时间不要写死
  const createdAt = "2024-09-20"
  ```

- **固定时间**：使用硬编码字符串
  ```javascript
  // ✅ 正确：历史日期、版本日期用字符串
  const effectiveDate = "2025年10月5日"
  const versionDate = "2024-09-20"
  const policyVersion = "v1.0"
  ```

═══════════════════════════════════════════════════════════════════════════════

## 📊 性能优化

### 小程序优化
- **减少setData调用**：批量更新数据，避免频繁渲染
  ```javascript
  // ✅ 正确
  this.setData({
    score: newScore,
    level: newLevel,
    status: 'playing'
  });
  
  // ❌ 错误
  this.setData({ score: newScore });
  this.setData({ level: newLevel });
  this.setData({ status: 'playing' });
  ```

- **图片优化**：使用WebP格式，合理压缩
- **数据缓存**：合理使用本地存储，避免重复请求

### 内存管理
- **及时清理**：页面卸载时清理定时器和监听器
  ```javascript
  onUnload() {
    if (this.timer) {
      clearInterval(this.timer);
      this.timer = null;
    }
  }
  ```

- **避免内存泄漏**：注意闭包和事件监听器的清理

═══════════════════════════════════════════════════════════════════════════════

## 🔒 安全规范

### 数据安全
- **输入验证**：所有用户输入必须验证和过滤
  ```javascript
  // ✅ 正确
  function validateInput(input) {
    if (!input || typeof input !== 'string') {
      throw new Error('Invalid input');
    }
    return input.trim();
  }
  ```

- **敏感信息**：不在代码中硬编码密钥和密码
- **数据加密**：敏感数据传输使用HTTPS

### 用户隐私保护
- **合规要求**：涉及用户隐私和个人信息收集时，必须严格遵守平台合规要求
- **隐私政策**：提供清晰的隐私政策说明，确保用户知情权
- **官方文档**：使用隐私相关API前必须查阅微信官方最新文档
- **合规审核**：避免使用可能引起审核问题的敏感词汇
  ```javascript
  // ✅ 正确：使用官方推荐API
  <button open-type="chooseAvatar" bindchooseavatar="onChooseAvatar">
  
  // ❌ 错误：使用已废弃的API
  wx.getUserProfile() // 已废弃
  
  // ✅ 正确：函数命名清晰
  uploadAvatar(avatarUrl)
  
  // ❌ 错误：使用可能引起审核疑虑的命名
  silentUploadAvatar(avatarUrl)
  ```

### 错误处理
- **异常捕获**：关键操作必须有异常处理
  ```javascript
  try {
    const result = await riskyOperation();
    return result;
  } catch (error) {
    console.error('操作失败:', error);
    wx.showToast({
      title: '操作失败，请重试',
      icon: 'none'
    });
    return null;
  }
  ```

═══════════════════════════════════════════════════════════════════════════════

## 🧪 测试规范

### 单元测试
- **覆盖率要求**：核心业务逻辑测试覆盖率 ≥ 70%
- **测试用例**：正常流程、异常流程、边界条件
  ```javascript
  describe('calculateScore', () => {
    test('正常得分计算', () => {
      const gameData = { level: 2, isWin: true };
      expect(calculateScore(gameData)).toBe(200);
    });
    
    test('异常数据处理', () => {
      expect(() => calculateScore(null)).toThrow('Invalid game data');
    });
  });
  ```

### 集成测试
- **模块协作**：确保模块间接口正常工作
- **端到端测试**：关键业务流程完整验证

═══════════════════════════════════════════════════════════════════════════════

## 📝 版本控制

### Git规范
- **提交信息**：格式统一，语义清晰
  ```
  feat: 添加新的计分规则
  fix: 修复游戏状态更新bug
  docs: 更新API文档
  style: 调整代码格式
  refactor: 重构计分逻辑
  test: 添加单元测试
  ```

- **分支管理**：
  - `main`: 主分支，稳定版本
  - `develop`: 开发分支
  - `feature/*`: 功能分支
  - `hotfix/*`: 紧急修复分支

### 代码审查
- **审查要点**：功能正确性、代码质量、安全性
- **审查流程**：自检 → 同事审查 → 合并

═══════════════════════════════════════════════════════════════════════════════

## 📚 文档规范

### 代码文档
- **README.md**：项目介绍、安装、使用说明
- **API文档**：接口说明、参数、返回值
- **变更日志**：版本更新记录

### 注释文档
- **行内注释**：复杂逻辑的说明
- **块注释**：函数和类的详细说明

═══════════════════════════════════════════════════════════════════════════════

## 🔄 持续改进

### 代码质量监控
- **静态分析**：使用ESLint等工具检查代码质量
- **性能监控**：定期检查性能指标
- **用户反馈**：收集用户使用反馈，持续优化

### 学习成长
- **技术更新**：关注新技术和最佳实践
- **团队分享**：定期技术分享和经验交流
- **代码重构**：定期重构，提升代码质量

═══════════════════════════════════════════════════════════════════════════════

## 🛡️ 平台合规规范

### 官方文档优先
- **技术选型前**：必须查阅平台官方最新文档，确保API未废弃
- **API使用前**：确认API符合最新规范和最佳实践
- **方案制定前**：了解平台限制、审核规范和最佳实践
  ```javascript
  // ✅ 正确：使用官方最新API
  <button open-type="chooseAvatar" bindchooseavatar="onChooseAvatar">
  
  // ❌ 错误：使用已废弃API
  wx.getUserProfile() // 2021年已废弃
  ```

### 微信小程序合规要点
- **头像昵称获取**：使用 `open-type="chooseAvatar"` 和 `type="nickname"`
- **隐私政策**：必须提供清晰、易访问的隐私政策
- **用户知情**：数据收集和使用必须让用户知情并同意
- **文件上传**：临时文件需上传到云存储获取永久ID
  ```javascript
  // ✅ 正确：上传到云存储
  wx.cloud.uploadFile({
    cloudPath: 'avatars/xxx.jpg',
    filePath: tempPath,
    success: res => {
      const cloudFileId = res.fileID // 永久ID
    }
  })
  ```

### 审核注意事项
- **函数命名**：避免使用"静默"、"silently"等可能引起合规疑虑的词汇
- **用户提示**：重要操作需有适当的用户提示
- **降级方案**：功能失败时提供合理的降级方案（如默认头像）

### 开发确认流程
- **方案先行**：制定详细技术方案后，先与用户确认
- **增量开发**：逐步实施，每步确认后再进行下一步
- **避免返工**：不要急于修改代码，确认无误后再执行

═══════════════════════════════════════════════════════════════════════════════

📝 **文档信息**

**创建时间**: 2024年9月20日  
**最后更新**: 2025年10月1日  
**负责人**: Jennifer  
**状态**: 持续更新中  
**版本**: v1.1.0
