# 云开发配置指南

## 📋 **配置完成清单**

### ✅ **已完成配置**

#### 1. **项目配置文件**
- ✅ `project.config.json` - 添加了 `cloudfunctionRoot: "cloudfunctions/"`
- ✅ `app.js` - 添加了云开发初始化代码
- ✅ `project.config.json` - 排除云函数目录上传到微信

#### 2. **云函数目录结构**
```
cloudfunctions/
├── roomManager/          # 房间管理云函数
│   ├── index.js         # 房间创建、加入、离开、状态管理
│   └── package.json     # 依赖配置
├── scoreSync/           # 计分同步云函数
│   ├── index.js         # 实时计分、历史记录、重置比分
│   └── package.json     # 依赖配置
├── userManager/         # 用户管理云函数
│   ├── index.js         # 用户信息、统计数据、历史记录
│   └── package.json     # 依赖配置
└── initDatabase/        # 数据库初始化云函数
    ├── index.js         # 创建集合、索引
    └── package.json     # 依赖配置
```

#### 3. **云函数功能说明**

##### **roomManager - 房间管理**
```javascript
// 支持的操作
- createRoom: 创建房间
- joinRoom: 加入房间
- leaveRoom: 离开房间
- getRoomInfo: 获取房间信息
- updateRoomStatus: 更新房间状态
```

##### **scoreSync - 计分同步**
```javascript
// 支持的操作
- updateScore: 更新比分
- getScoreHistory: 获取计分历史
- resetScore: 重置比分
```

##### **userManager - 用户管理**
```javascript
// 支持的操作
- getUserProfile: 获取用户信息
- createUser: 创建用户
- updateUserStats: 更新用户统计
- getUserHistory: 获取用户历史
```

##### **initDatabase - 数据库初始化**
```javascript
// 功能
- 创建数据库集合 (rooms, users, game_records)
- 创建索引优化查询性能
```

## 🚀 **下一步操作指南**

### **在微信开发者工具中的操作**

#### 1. **开通云开发服务**
1. 打开微信开发者工具
2. 选择你的项目
3. 点击工具栏 "云开发" 按钮
4. 开通云开发服务（选择套餐）
5. 记录环境ID（如：`guandan-score-prod`）

#### 2. **上传云函数**
1. 右键点击 `cloudfunctions/roomManager` 文件夹
2. 选择 "上传并部署：云端安装依赖"
3. 重复步骤，上传其他云函数：
   - `scoreSync`
   - `userManager`
   - `initDatabase`

#### 3. **初始化数据库**
1. 上传 `initDatabase` 云函数后
2. 在云开发控制台调用该函数
3. 或者在小程序中调用：
```javascript
wx.cloud.callFunction({
  name: 'initDatabase',
  success: res => console.log('数据库初始化成功', res),
  fail: err => console.error('数据库初始化失败', err)
});
```

#### 4. **更新环境ID**
如果云开发环境ID不是 `guandan-score-prod`，需要更新：
```javascript
// 在 app.js 中修改
cloudEnv: 'your-actual-env-id'
```

## 📊 **数据库集合说明**

### **rooms 集合**
- **用途**: 存储房间信息和实时数据
- **索引**: roomCode(唯一), creatorId, createdAt

### **users 集合**
- **用途**: 存储用户信息和统计数据
- **索引**: lastActiveAt

### **game_records 集合**
- **用途**: 存储游戏历史记录（可选）
- **索引**: playerId+createdAt, roomId

## 🔧 **测试云函数**

### **测试房间创建**
```javascript
wx.cloud.callFunction({
  name: 'roomManager',
  data: {
    action: 'createRoom',
    data: {
      roomCode: '123456',
      creatorName: '测试房主',
      mode: 'guanda'
    }
  }
});
```

### **测试用户创建**
```javascript
wx.cloud.callFunction({
  name: 'userManager',
  data: {
    action: 'createUser',
    data: {
      nickName: '测试用户',
      avatar: ''
    }
  }
});
```

## ⚠️ **注意事项**

1. **环境ID**: 确保 `app.js` 中的环境ID与云开发控制台一致
2. **权限设置**: 云函数默认只有创建者可以调用
3. **数据库权限**: 需要在云开发控制台设置数据库权限
4. **费用控制**: 云开发按使用量计费，注意控制调用次数

## 🎯 **配置验证**

配置完成后，可以通过以下方式验证：

1. **云函数调用测试**: 在小程序中调用云函数，检查返回结果
2. **数据库连接测试**: 查看云开发控制台的数据库，确认集合已创建
3. **日志查看**: 在云开发控制台查看云函数执行日志

---

**配置完成后，我们就可以开始前端界面的开发了！** 🚀

