<view class="container cn-paper-bg">
  <image class="cn-ornament left" 
         src="{{leftBorderImage}}" 
         mode="heightFix" 
         lazy-load="{{true}}"
         binderror="onImageError"/>
  <image class="cn-ornament right" 
         src="{{rightBorderImage}}" 
         mode="heightFix" 
         lazy-load="{{true}}"
         binderror="onImageError"/>
  
  <!-- ç¯å¢ƒæ ‡è¯† -->
  <view class="env-badge">
    <text wx:if="{{isTrial}}" class="env-text trial">ä½“éªŒç‰ˆ</text>
    <text wx:elif="{{isDevelop}}" class="env-text develop">å¼€å‘ç‰ˆ</text>
  </view>
  
  <!-- å·¦ä¾§å¯¼èˆªæŒ‰é’®ç»„ -->
  <view class="left-nav-panel">
    <button class="nav-btn" bindtap="onShowHistory">
      <text class="nav-icon-text">ğŸ“Š</text>
      <text class="nav-text">å†å²è®°å½•</text>
    </button>
    <button class="nav-btn" bindtap="onShowHelp">
      <text class="nav-icon-text">â“</text>
      <text class="nav-text">è¯´æ˜æ–‡æ¡£</text>
    </button>
    <button class="nav-btn" bindtap="onShowFeedback">
      <text class="nav-icon-text">ğŸ’¬</text>
      <text class="nav-text">åé¦ˆ</text>
    </button>
    <button class="nav-btn" bindtap="onShowSettings">
      <text class="nav-icon-text">âš™ï¸</text>
      <text class="nav-text">è®¾ç½®</text>
    </button>
  </view>
  
  <!-- æŠŠæ•°æ˜¾ç¤º - ç§»åˆ°ä½“éªŒç‰ˆä¸‹æ–¹ -->
  <view class="left-rounds-display">
    <view class="rounds-clock">
      <view class="rounds-number">
        <text wx:if="{{rounds > 0}}" class="rounds-text-large">{{rounds}}</text>
        <text wx:else class="rounds-text-small">æŠŠæ•°</text>
      </view>
    </view>
  </view>
  
  <!-- çº¢æ–¹ & è“æ–¹ å¹¶æ’ -->
  <view class="main-layout">
    <!-- çº¢æ–¹ -->
    <view class="team red-team">
      <view class="team-layout">
        <!-- çº¢æ–¹ç‹¬ç«‹å‡çº§æŒ‰é’®ç»„ - æ”¾åœ¨å·¦ä¾§ -->
        <view class="team-buttons left-buttons">
          <view class="team-btn team-btn-double {{buttonDisabledStates.red.double ? 'btn-disabled' : ''}}" data-team="red" data-value="3" bindtap="onLevelUpgrade" disabled="{{!gameStarted || gameEnded}}">
            <image src="../../images/arrow_up.svg" class="btn-icon"></image>
            <text class="btn-number">3</text>
          </view>
          <view class="team-btn team-btn-two {{buttonDisabledStates.red.two ? 'btn-disabled' : ''}}" data-team="red" data-value="2" bindtap="onLevelUpgrade" disabled="{{!gameStarted || gameEnded}}">
            <image src="../../images/arrow_up.svg" class="btn-icon"></image>
            <text class="btn-number">2</text>
          </view>
          <view class="team-btn team-btn-one {{buttonDisabledStates.red.one ? 'btn-disabled' : ''}}" data-team="red" data-value="1" bindtap="onLevelUpgrade" disabled="{{!gameStarted || gameEnded}}">
            <image src="../../images/arrow_up.svg" class="btn-icon"></image>
            <text class="btn-number">1</text>
          </view>
        </view>
        <view class="score-container">
          <text class="team-label">ä¸œè¥¿æ–¹</text>
          <view class="level-display">
            <view class="level-display-content">
              <text class="level-text">{{levelTexts.red}}</text>
            </view>
            <image wx:if="{{showRedIcon}}" src="../../images/victor.svg" class="score-icon"/>
          </view>
        </view>
      </view>
    </view>

    <!-- è“æ–¹ -->
    <view class="team blue-team">
      <view class="team-layout">
        <view class="score-container">
          <text class="team-label">å—åŒ—æ–¹</text>
          <view class="level-display">
            <view class="level-display-content">
              <text class="level-text">{{levelTexts.blue}}</text>
            </view>
            <image wx:if="{{showBlueIcon}}" src="../../images/victor.svg" class="score-icon"/>
          </view>
        </view>
        <!-- è“æ–¹ç‹¬ç«‹å‡çº§æŒ‰é’®ç»„ - æ”¾åœ¨å³ä¾§ -->
        <view class="team-buttons right-buttons">
          <view class="team-btn team-btn-double {{buttonDisabledStates.blue.double ? 'btn-disabled' : ''}}" data-team="blue" data-value="3" bindtap="onLevelUpgrade" disabled="{{!gameStarted || gameEnded}}">
            <image src="../../images/arrow_up.svg" class="btn-icon"></image>
            <text class="btn-number">3</text>
          </view>
          <view class="team-btn team-btn-two {{buttonDisabledStates.blue.two ? 'btn-disabled' : ''}}" data-team="blue" data-value="2" bindtap="onLevelUpgrade" disabled="{{!gameStarted || gameEnded}}">
            <image src="../../images/arrow_up.svg" class="btn-icon"></image>
            <text class="btn-number">2</text>
          </view>
          <view class="team-btn team-btn-one {{buttonDisabledStates.blue.one ? 'btn-disabled' : ''}}" data-team="blue" data-value="1" bindtap="onLevelUpgrade" disabled="{{!gameStarted || gameEnded}}">
            <image src="../../images/arrow_up.svg" class="btn-icon"></image>
            <text class="btn-number">1</text>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- æ¯”åˆ†å†å²è¡¨æ ¼ - ä¼˜åŒ–ç‰ˆ -->
  <view class="history-table-section">
    <view class="history-header">
  <text class="history-title">æœ¬å±€æ¯æŠŠæ¯”åˆ†</text>
  <view class="history-actions">
    <button class="undo-btn" bindtap="undoLastStep" disabled="{{!canUndo}}">
      <image src="../../images/CexiaoGrey.svg" class="undo-icon"></image>
      <text class="undo-text">æ’¤é”€ä¸Šä¸€æŠŠ</text>
    </button>
    <button class="restore-btn" bindtap="restoreLastGame" disabled="{{!canRestore}}">
      <text class="restore-text">æ¢å¤æ¸¸æˆ</text>
    </button>
  </view>
</view>
    
    <!-- å›ºå®šé˜Ÿä¼åˆ— -->
    <view class="fixed-team-column">
      <view class="fixed-team-cell header-cell">æŠŠæ•°</view>
      <view class="fixed-team-cell">çº¢æ–¹</view>
      <view class="fixed-team-cell">è“æ–¹</view>
    </view>
    
    <!-- å¯æ»šåŠ¨çš„è¡¨æ ¼å†…å®¹ -->
    <view class="scrollable-table-container">
      <!-- è¡¨æ ¼å¤´éƒ¨ -->
      <view class="table-row header-row">
        <view class="table-cell">ä¸€</view>
        <view class="table-cell">äºŒ</view>
        <view class="table-cell">ä¸‰</view>
        <view class="table-cell">å››</view>
        <view class="table-cell">äº”</view>
        <view class="table-cell">å…­</view>
        <view class="table-cell">ä¸ƒ</view>
        <view class="table-cell">å…«</view>
        <view class="table-cell">ä¹</view>
        <view class="table-cell">å</view>
        <view class="table-cell">åä¸€</view>
        <view class="table-cell">åäºŒ</view>
        <view class="table-cell">åä¸‰</view>
        <view class="table-cell">åå››</view>
        <view class="table-cell">åäº”</view>
        <view class="table-cell">åå…­</view>
        <view class="table-cell">åä¸ƒ</view>
        <view class="table-cell">åå…«</view>
      </view>
      
      <!-- çº¢æ–¹è¡Œ -->
      <view class="table-row">
        <view class="table-cell red-score" bindlongpress="onLongPressHistory" data-index="0">{{historyScores[0] && historyScores[0].red ? historyScores[0].red : '-'}}</view>
        <view class="table-cell red-score" bindlongpress="onLongPressHistory" data-index="1">{{historyScores[1] && historyScores[1].red ? historyScores[1].red : '-'}}</view>
        <view class="table-cell red-score" bindlongpress="onLongPressHistory" data-index="2">{{historyScores[2] && historyScores[2].red ? historyScores[2].red : '-'}}</view>
        <view class="table-cell red-score" bindlongpress="onLongPressHistory" data-index="3">{{historyScores[3] && historyScores[3].red ? historyScores[3].red : '-'}}</view>
        <view class="table-cell red-score" bindlongpress="onLongPressHistory" data-index="4">{{historyScores[4] && historyScores[4].red ? historyScores[4].red : '-'}}</view>
        <view class="table-cell red-score" bindlongpress="onLongPressHistory" data-index="5">{{historyScores[5] && historyScores[5].red ? historyScores[5].red : '-'}}</view>
        <view class="table-cell red-score" bindlongpress="onLongPressHistory" data-index="6">{{historyScores[6] && historyScores[6].red ? historyScores[6].red : '-'}}</view>
        <view class="table-cell red-score" bindlongpress="onLongPressHistory" data-index="7">{{historyScores[7] && historyScores[7].red ? historyScores[7].red : '-'}}</view>
        <view class="table-cell red-score" bindlongpress="onLongPressHistory" data-index="8">{{historyScores[8] && historyScores[8].red ? historyScores[8].red : '-'}}</view>
        <view class="table-cell red-score" bindlongpress="onLongPressHistory" data-index="9">{{historyScores[9] && historyScores[9].red ? historyScores[9].red : '-'}}</view>
        <view class="table-cell red-score" bindlongpress="onLongPressHistory" data-index="10">{{historyScores[10] && historyScores[10].red ? historyScores[10].red : '-'}}</view>
        <view class="table-cell red-score" bindlongpress="onLongPressHistory" data-index="11">{{historyScores[11] && historyScores[11].red ? historyScores[11].red : '-'}}</view>
        <view class="table-cell red-score" bindlongpress="onLongPressHistory" data-index="12">{{historyScores[12] && historyScores[12].red ? historyScores[12].red : '-'}}</view>
        <view class="table-cell red-score" bindlongpress="onLongPressHistory" data-index="13">{{historyScores[13] && historyScores[13].red ? historyScores[13].red : '-'}}</view>
        <view class="table-cell red-score" bindlongpress="onLongPressHistory" data-index="14">{{historyScores[14] && historyScores[14].red ? historyScores[14].red : '-'}}</view>
        <view class="table-cell red-score" bindlongpress="onLongPressHistory" data-index="15">{{historyScores[15] && historyScores[15].red ? historyScores[15].red : '-'}}</view>
        <view class="table-cell red-score" bindlongpress="onLongPressHistory" data-index="16">{{historyScores[16] && historyScores[16].red ? historyScores[16].red : '-'}}</view>
        <view class="table-cell red-score" bindlongpress="onLongPressHistory" data-index="17">{{historyScores[17] && historyScores[17].red ? historyScores[17].red : '-'}}</view>
      </view>
      
      <!-- è“æ–¹è¡Œ -->
      <view class="table-row">
        <view class="table-cell blue-score" bindlongpress="onLongPressHistory" data-index="0">{{historyScores[0] && historyScores[0].blue ? historyScores[0].blue : '-'}}</view>
        <view class="table-cell blue-score" bindlongpress="onLongPressHistory" data-index="1">{{historyScores[1] && historyScores[1].blue ? historyScores[1].blue : '-'}}</view>
        <view class="table-cell blue-score" bindlongpress="onLongPressHistory" data-index="2">{{historyScores[2] && historyScores[2].blue ? historyScores[2].blue : '-'}}</view>
        <view class="table-cell blue-score" bindlongpress="onLongPressHistory" data-index="3">{{historyScores[3] && historyScores[3].blue ? historyScores[3].blue : '-'}}</view>
        <view class="table-cell blue-score" bindlongpress="onLongPressHistory" data-index="4">{{historyScores[4] && historyScores[4].blue ? historyScores[4].blue : '-'}}</view>
        <view class="table-cell blue-score" bindlongpress="onLongPressHistory" data-index="5">{{historyScores[5] && historyScores[5].blue ? historyScores[5].blue : '-'}}</view>
        <view class="table-cell blue-score" bindlongpress="onLongPressHistory" data-index="6">{{historyScores[6] && historyScores[6].blue ? historyScores[6].blue : '-'}}</view>
        <view class="table-cell blue-score" bindlongpress="onLongPressHistory" data-index="7">{{historyScores[7] && historyScores[7].blue ? historyScores[7].blue : '-'}}</view>
        <view class="table-cell blue-score" bindlongpress="onLongPressHistory" data-index="8">{{historyScores[8] && historyScores[8].blue ? historyScores[8].blue : '-'}}</view>
        <view class="table-cell blue-score" bindlongpress="onLongPressHistory" data-index="9">{{historyScores[9] && historyScores[9].blue ? historyScores[9].blue : '-'}}</view>
        <view class="table-cell blue-score" bindlongpress="onLongPressHistory" data-index="10">{{historyScores[10] && historyScores[10].blue ? historyScores[10].blue : '-'}}</view>
        <view class="table-cell blue-score" bindlongpress="onLongPressHistory" data-index="11">{{historyScores[11] && historyScores[11].blue ? historyScores[11].blue : '-'}}</view>
        <view class="table-cell blue-score" bindlongpress="onLongPressHistory" data-index="12">{{historyScores[12] && historyScores[12].blue ? historyScores[12].blue : '-'}}</view>
        <view class="table-cell blue-score" bindlongpress="onLongPressHistory" data-index="13">{{historyScores[13] && historyScores[13].blue ? historyScores[13].blue : '-'}}</view>
        <view class="table-cell blue-score" bindlongpress="onLongPressHistory" data-index="14">{{historyScores[14] && historyScores[14].blue ? historyScores[14].blue : '-'}}</view>
        <view class="table-cell blue-score" bindlongpress="onLongPressHistory" data-index="15">{{historyScores[15] && historyScores[15].blue ? historyScores[15].blue : '-'}}</view>
        <view class="table-cell blue-score" bindlongpress="onLongPressHistory" data-index="16">{{historyScores[16] && historyScores[16].blue ? historyScores[16].blue : '-'}}</view>
        <view class="table-cell blue-score" bindlongpress="onLongPressHistory" data-index="17">{{historyScores[17] && historyScores[17].blue ? historyScores[17].blue : '-'}}</view>
      </view>
    </view>
  </view>

  <!-- å³ä¾§æ§åˆ¶é¢æ¿ -->
  <view class="right-control-panel">
    <!-- å¼€å§‹æ¸¸æˆæŒ‰é’® -->
    <button class="start-btn" bindtap="onStartGame" disabled="{{gameStarted || gameEnded}}">
      {{gameStarted ? 'æ¸¸æˆè¿›è¡Œä¸­' : 'å¼€å§‹æ¸¸æˆ'}}
    </button>

    <!-- è§„åˆ™é€‰æ‹© -->
    <view class="rule-section">
      <text>è§„åˆ™ï¼š</text>
      <radio-group bindchange="onRuleChange" disabled="{{gameStarted || gameEnded}}">
        <label><radio value="by-A" checked="{{rule === 'by-A'}}" disabled="{{gameStarted || gameEnded}}"/>è¿‡A</label>
        <label>
          <radio value="by-rounds" checked="{{rule === 'by-rounds'}}" disabled="{{gameStarted || gameEnded}}"/>æŠŠæ•°
          <view wx:if="{{rule === 'by-rounds'}}" class="rounds-selector">
            <picker range="{{[5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15]}}" value="{{maxRounds === 5 ? 0 : maxRounds === 6 ? 1 : maxRounds === 7 ? 2 : maxRounds === 8 ? 3 : maxRounds === 9 ? 4 : maxRounds === 10 ? 5 : maxRounds === 11 ? 6 : maxRounds === 12 ? 7 : maxRounds === 13 ? 8 : maxRounds === 14 ? 9 : 10}}" bindchange="onMaxRoundsChange" disabled="{{gameStarted || gameEnded}}">
              <view class="picker">{{maxRounds}}</view>
            </picker>
          </view>
        </label>
      </radio-group>
    </view>

    <!-- ç»“æŸæœ¬å±€æŒ‰é’® -->
    <button class="end-btn" bindtap="onEndGame">ç»“æŸ</button>
  </view>

  <!-- è®¾ç½®å¼¹çª— -->
  <view class="settings-modal" wx:if="{{showSettingsModal}}">
    <view class="settings-overlay" bindtap="onCloseSettings"></view>
    <view class="settings-content">
      <!-- å¼¹çª—æ ‡é¢˜ -->
      <view class="settings-header">
        <text class="settings-title">è®¾ç½®</text>
        <view class="close-btn" bindtap="onCloseSettings">
          <text class="close-icon">Ã—</text>
        </view>
      </view>
      
      <!-- è®¾ç½®é€‰é¡¹ -->
      <view class="settings-options">
        <!-- æ¸¸æˆè®¾ç½® -->
        <view class="settings-section">
          <text class="section-title">æ¸¸æˆè®¾ç½®</text>
          
          <view class="option-item">
            <text class="option-label">é»˜è®¤è®¡åˆ†è§„åˆ™</text>
            <view class="option-value">
              <picker bindchange="onRuleChange" value="{{ruleIndex}}" range="{{ruleOptions}}">
                <view class="picker-text">{{ruleOptions[ruleIndex]}}</view>
              </picker>
            </view>
          </view>
          
          <view class="option-item">
            <text class="option-label">æœ€å¤§æŠŠæ•°</text>
            <view class="option-value">
              <picker bindchange="onMaxRoundsChange" value="{{maxRoundsIndex}}" range="{{maxRoundsOptions}}">
                <view class="picker-text">{{maxRoundsOptions[maxRoundsIndex]}}</view>
              </picker>
            </view>
          </view>
        </view>
        
        <!-- æ˜¾ç¤ºè®¾ç½® -->
        <view class="settings-section">
          <text class="section-title">æ˜¾ç¤ºè®¾ç½®</text>
          
          <view class="option-item">
            <text class="option-label">æ˜¾ç¤ºç¯å¢ƒæ ‡è¯†</text>
            <switch checked="{{showEnvBadge}}" bindchange="onEnvBadgeChange" color="#EE1967"/>
          </view>
          
          <view class="option-item">
            <text class="option-label">æ˜¾ç¤ºç‚¹å‡»æç¤º</text>
            <switch checked="{{showClickToast}}" bindchange="onClickToastChange" color="#EE1967"/>
          </view>
        </view>
        
        <!-- æ•°æ®è®¾ç½® -->
        <view class="settings-section">
          <text class="section-title">æ•°æ®è®¾ç½®</text>
          
          <view class="option-item">
            <text class="option-label">è‡ªåŠ¨ä¿å­˜</text>
            <switch checked="{{autoSave}}" bindchange="onAutoSaveChange" color="#EE1967"/>
          </view>
          
          <view class="option-item">
            <text class="option-label">æ¸…ç©ºå†å²è®°å½•</text>
            <view class="option-value">
              <button class="clear-btn" bindtap="onClearHistory">æ¸…ç©º</button>
            </view>
          </view>
        </view>
      </view>
      
      <!-- å¼¹çª—åº•éƒ¨æŒ‰é’® -->
      <view class="settings-footer">
        <button class="settings-btn cancel-btn" bindtap="onCloseSettings">å–æ¶ˆ</button>
        <button class="settings-btn confirm-btn" bindtap="onSaveSettings">ä¿å­˜</button>
      </view>
    </view>
  </view>
</view>